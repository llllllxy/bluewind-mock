<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="renderer" content="webkit">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no">

    <!-- 引入element-ui的css -->
    <link rel="stylesheet" th:href="@{/lib/element-ui/theme-chalk/index.css}">
    <link rel="stylesheet" th:href="@{/css/public.css}">

    <!-- 引入vue和vue-i18n的js -->
    <script th:src="@{/lib/vue/vue.min.js}"></script>
    <script th:src="@{/lib/vue/vue-i18n.js}"></script>
    <!-- 引入axios和qs的js -->
    <script th:src="@{/lib/axios.min.js}"></script>
    <script th:src="@{/lib/qs.min.js}"></script>
    <!-- 引入element-ui的js -->
    <script th:src="@{/lib/element-ui/index.js}"></script>

    <script th:src="@{/lib/clipboard.min.js}"></script>

    <title>Mock平台</title>

    <style>
        html, body {
            margin: 0;
            height: 100%;
        }

        .text {
            font-size: 14px;
        }

        .item {
            margin-bottom: 18px;
        }

        .clearfix:before,
        .clearfix:after {
            display: table;
            content: "";
        }

        .clearfix:after {
            clear: both
        }

        .app-container {
            padding: 0px 10px 10px 10px;
        }
        .searchDiv {
            margin-bottom: 15px;
        }
        .width1 {
            width: 220px;
            margin-right: 10px;
        }

        .pagination-container {
            padding: 10px 16px 16px 16px;
            float: left;
        }
    </style>
</head>

<body>
<div id="app" style="height: 100%;">
    <div>
        <el-row>
            <el-col :span="6" v-for="(item,index) in items"
                    style="margin-bottom:25px;position: relative;">

                <el-card style="width: 94%;margin-left: 3%" shadow="hover">
                    <div slot="header" class="clearfix">
                        <span style="font-weight: bold">{{item.projectName}}</span>
                        <el-button @click="toMockList(item)" style="float: right; padding: 3px 0" type="text">进入项目</el-button>
                    </div>
                    <div class="text item">
                        <span>描述：{{item.introduce}}</span>
                    </div>
                    <div class="text item">
                        <span>路径：{{item.path}}</span>
                    </div>
                    <div class="text">
                        <span>操作：</span>
                        <el-button-group>
                            <el-tooltip effect="light" content="复制项目地址" placement="bottom">
                                <el-button size="small" icon="el-icon-connection"
                                           @click="copy($event, item)"></el-button>
                            </el-tooltip>
                            <el-tooltip effect="light" content="编辑项目" placement="bottom">
                                <el-button size="small" icon="el-icon-edit"></el-button>
                            </el-tooltip>
                            <el-tooltip effect="light" content="删除项目" placement="bottom">
                                <el-button size="small" icon="el-icon-delete"></el-button>
                            </el-tooltip>
                        </el-button-group>
                    </div>
                </el-card>
            </el-col>

        </el-row>
    </div>

    <!-- 弹出 dialog Mock列表-->
    <el-dialog title="Mock列表" :visible.sync="dialogVisible" :fullscreen="true">
        <div class="app-container">
            <div class="searchDiv">
                <el-form ref="mockListQueryForm" :inline="true" :model="queryParams" class="demo-form-inline">
                    <el-form-item label="url路径">
                        <el-input type="text" placeholder="请输入url路径" clearable v-model="queryParams.url"
                                  class="width1"></el-input>
                    </el-form-item>
                    <el-form-item label="接口类型">
                        <el-select v-model="queryParams.method" placeholde="请选择接口类型" clearable class="width1">
                            <el-option v-for="item in methodOptions" :label="item.label" :value="item.value"
                                       :key="item.value"></el-option>
                        </el-select>
                    </el-form-item>

                    <el-button type="primary" icon="el-icon-search" @click="searchMockList()">搜索</el-button>
                </el-form>

                <el-row :gutter="10" class="mb8">
                    <el-col :span="1.5">
                        <el-button type="danger" icon="el-icon-delete" @click="delLog()"
                                   v-has-permission="['monitor:loginlog:delete']">新增
                        </el-button>
                        <el-button type="danger" icon="el-icon-delete" @click="delLog()"
                                   v-has-permission="['monitor:loginlog:delete']">删除
                        </el-button>
                    </el-col>
                </el-row>
            </div>

            <el-table :data="mockList" v-loading="loading" stripe>
                <el-table-column label="序号" type="index" width="100" align="center">
                    <template slot-scope="scope">
                        {{(queryParams.pageNum - 1) * queryParams.pageSize + scope.$index + 1}}
                    </template>
                </el-table-column>
                <el-table-column prop="url" label="url路径"></el-table-column>
                <el-table-column prop="method" label="请求类型" width="210">
                    <template slot-scope="scope">
                        <el-tag :type="scope.row.method | tagClass">
                            {{scope.row.method | methodText(methodTextDict)}}
                        </el-tag>
                    </template>
                </el-table-column>
                <el-table-column prop="introduce" label="简介"></el-table-column>
                <el-table-column prop="createTime" label="创建时间"></el-table-column>
                <el-table-column prop="updateTime" label="更新时间"></el-table-column>
                <el-table-column label="操作" width="100" align="center">
                    <template slot-scope="scope">
                        <el-button type="danger" size="mini" @click="delOneLog(scope.row.logId)">删除</el-button>
                    </template>
                </el-table-column>
            </el-table>

            <el-pagination class="pagination-container" background
                    :current-page.sync="queryParams.pageNum"
                    :page-size.sync="queryParams.pageSize"
                    :page-sizes="[5,10,20,50]"
                    layout="total, sizes, prev, pager, next, jumper"
                    :total="total"
                    @size-change="handleSizeChange"
                    @current-change="handleCurrentChange"
            />
        </div>
    </el-dialog>

</div>
</body>

<script type="text/javascript" th:inline="javascript">
    let ctx = /*[[@{/}]]*/'';

    new Vue({
        el: '#app',
        data: function () {
            return {
                activeIndex: 'myproject',
                items: [],
                dialogVisible: false,
                currentProjectId: '',
                // 遮罩层
                loading: false,
                // 表格数据
                mockList: [],
                // 总条数
                total: 0,
                // 查询参数
                queryParams: {
                    pageNum: 1,
                    pageSize: 5,
                    url: undefined,
                    method: undefined
                },
                methodOptions: [
                    { label: 'GET', value: 'GET' },
                    { label: 'POST', value: 'POST' },
                ],
                methodTextDict: {
                    'GET': 'GET',
                    'POST': 'POST'
                }
            }
        },
        filters: {
            methodText(val, methodTextDict) {
                return methodTextDict[val];
            },
            tagClass(val) {
                if (val === undefined) {
                    return
                }
                if (val === 'POST') {
                    return 'success'
                } else if (val === 'GET') {
                    return 'info'
                }
            }
        },
        methods: {
            getProjectList: function () {
                axios({
                    method: 'get',
                    url: ctx + "project/list"
                }).then((res) => {
                    if (res.data.code === 200) {
                        this.items = res.data.data;
                    } else {
                        this.$message.error(res.data.msg);
                    }
                }).catch((res) => {
                    console.log(res);
                })
            },
            toMockList(item) {
                this.currentProjectId = item.projectId;
                // 每次打开，重置查询条件
                this.queryParams = {
                    pageNum: 1,
                    pageSize: 5,
                    url: undefined,
                    method: undefined
                };
                this.dialogVisible = true;
                this.searchMockList();
            },
            searchMockList() {
                this.queryParams.pageNum = 1;
                this.getMockList();
            },
            handleSizeChange() {
                this.getMockList();
            },
            handleCurrentChange() {
                this.getMockList();
            },
            getMockList() {
                this.loading = true;
                this.queryParams.projectId = this.currentProjectId;
                axios({
                    method: 'post',
                    url: ctx + "mock/list",
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8'
                    },
                    data: Qs.stringify(this.queryParams)
                }).then((res) => {
                    this.loading = false;
                    if (res.data.code === 200) {
                        this.mockList = res.data.data.rows;
                        this.total = res.data.data.total;
                    } else {
                        this.$message.error(res.data.msg);
                    }
                }).catch((res) => {
                    this.loading = false;
                    console.log(res);
                })
            },
            delLog() {

            },
            delOneLog(logId) {

            },
            emptyLog() {

            },

            getIpHost: function () {
                return 'http://' + window.location.host + '/';
            },
            copy: function (event, item) {
                this.handleClipboard(item, event);
            },
            handleClipboard(item, event) {
                let text = this.getIpHost() + item.projectId + item.path;
                const clipboard = new ClipboardJS(event.target, {
                    text: () => text
                });
                clipboard.on('success', () => {
                    this.clipboardSuccess(text);
                    clipboard.destroy();
                });
                clipboard.on('error', () => {
                    this.clipboardError();
                    clipboard.destroy();
                });
                clipboard.onClick(event);
            },
            clipboardSuccess(text) {
                this.$message({
                    message: '已复制到粘贴板',
                    type: 'success'
                });
            },
            clipboardError() {
                this.$message.error('Copy error');
            },
        },

        mounted: function () {
            this.getProjectList();
        }
    })

</script>

</html>